<style>
canvas {
  height: 360px;
  width: 480px;
  visibility: hidden;
}
video {
  visibility: hidden;
}
html, body {
  font-size: 12px;
}
#output {
  position: absolute;
  text-align: center;
  width: 100%;
  left: 50%;
  top: 50%;
  transform: translate(-50%,-50%);
}
</style>
<script>
const emoji_height = 36;
const emoji_width = 48;

async function getImage() {
	const video = document.querySelector('video');
  const canvas = document.querySelector('canvas');
  const context = canvas.getContext('2d')
  canvas.width = emoji_width * 36;
  canvas.height = emoji_height * 36;
  context.drawImage(video, 0, 0, canvas.width, canvas.height);
  const data = context.getImageData(0, 0, canvas.width, canvas.height).data;
  const response = await fetch(window.location.href, {
    method: 'POST',
    body: data
  })
  const emojis = await response.json()
  const div = document.getElementById('output')
  div.replaceChildren()
  for (let i = 0; i < emoji_height; ++i) {
    let str = ''
    for (let j = 0; j < emoji_width; ++j) {
      str += emojis[i * emoji_width + j]
    }
    const subdiv = document.createElement('div');
    subdiv.style.height = '16px';
    subdiv.textContent = str;
    div.appendChild(subdiv);
  }
}

async function loop() {
  await getImage()
  window.requestAnimationFrame(loop)
}

function load() {
	const video = document.querySelector('video');
  video.addEventListener('play', loop)
  navigator.mediaDevices
      .getUserMedia({ video: true, audio: false })
      .then((stream) => {
        video.srcObject = stream;
        video.play();
      })
      .catch((err) => {
        console.error(`An error occurred: ${err}`);
      });
}
window.addEventListener('load', load)
</script>

<div id='output'> </div>
<video></video>
<canvas></canvas>
